---
title: "S8_2_Modèles linéaires mixtes"
format:
    html:
        toc: true
        toc-depth: 5
        toc-title: "Table of contents"
        toc-location: left
        toc-sticky: true
        number-sections: true
        theme: default

    docx:
        toc: true
        toc-depth: 5

    pdf:
        toc: true
        toc-depth: 5
        pdf-engine: xelatex
        number-sections: true
        header-includes: |
            % Réduit automatiquement la taille des titres des graphiques avant qu'ils ne dépassent
            \usepackage{graphicx}
            \usepackage{adjustbox}
            % Réduction automatique de la taille des titres des figures (plots R)
            \makeatletter
            \AtBeginEnvironment{figure}{\small}
            \makeatother
            \usepackage{fontspec} 
            \setmainfont{Helvetica}
            \usepackage{etoolbox}
            \renewcommand{\contentsname}{}
            \AtBeginDocument{
                \addtocontents{toc}{\protect\smallskip}
                \let\oldtableofcontents\tableofcontents
                \renewcommand{\tableofcontents}{
                \begingroup
                    \footnotesize
                    \setlength{\parskip}{2pt}
                    \oldtableofcontents
                \endgroup
                }
            }
            \setcounter{tocdepth}{5}
            \makeatletter
            \renewcommand{\@tocrmarg}{0pt}
            \makeatother
            \usepackage{fvextra}
            \usepackage[section]{placeins}
            \usepackage{needspace}
            \usepackage{float}
            \floatplacement{figure}{H}
            \floatplacement{table}{H}
            \newcommand{\sectionbreak}{\needspace{5\baselineskip}}
            \setlength{\parindent}{0pt}
            \setlength{\parskip}{4pt}
            \usepackage[most]{tcolorbox}
            \usepackage{color}
            \definecolor{lightgray}{gray}{0.95}
            \newtcolorbox{graybox}{colback=gray!10!white,colframe=black,boxrule=0.6pt,arc=1mm,left=6pt,right=6pt,top=4pt,bottom=4pt}
            \newtcolorbox{codebox}{breakable,colback=blue!5!white,colframe=blue!50!black,boxrule=0.5pt,arc=1mm,left=4pt,right=4pt,top=3pt,bottom=3pt}
            \DefineVerbatimEnvironment{CodeBoxContent}{Verbatim}{fontsize=\small,breaklines,breakanywhere}
            \renewcommand{\thesection}{\arabic{section}}
            \renewcommand{\thesubsection}{\thesection.\Alph{subsection}}
            \renewcommand{\thesubsubsection}{\thesubsection.\arabic{subsubsection}}

geometry: margin=2.5cm
---

```{r}
#| label: setup
#| include: false
#| echo: false
library(forecast)
library(plotrix)
library(viridisLite)
library(ggplot2)
library(survminer)
library(treemap)
library(psy)
library(qgraph)
library(ape)
library(survival)
library(httpgd)
library(psy)
knitr::opts_chunk$set(echo = TRUE)

load("~/Documents/Projets/M2biostatistiques/Cours/CUSM_data/CUSM")
gs <- read.csv2("~/Documents/Projets/M2biostatistiques/Cours/CUSM_data/GoogleSuicide20172022.csv")
load("~/Documents/Projets/M2biostatistiques/Cours/CUSM_data/dataAQRlivre")
data(expsy)
alzh = read.csv("~/Documents/Projets/M2biostatistiques/Cours/alzheimer.csv")
```

# Plan du cours

# Introduction aux modèles linéaires mixtes

-   Principale limitation du modèle linéaire : l'hypothèse des observations indépendantes = indépendance des résidus

    -   Observations doivent rester indépendantes après avoir été ajustées pour les prédicteurs fixes (âge, sexe)

    -   Par ex : "patients-trimestres" : ce sont les mêmes patients qui sont mesurés à plusieurs reprises

-   Problème : en pratique, il existe bcp de situation ou c'est pas raisonnable

    -   patients d'un essai clinique sont inclus dans plusieurs centres : deux patients d'un même centre se ressemblent plus que deux patients de centres différents

    -   méta-analyse vise à synthétiser les résultats de plusieurs essais thérapeutiques

    -   unité statistique est la "visite" d'un patient dans un service, mais le même patient peut revenir plusieurs fois

    -   la même mesure biologique est répétée plusieurs fois chez un même individu (données longitudinales)

-   Conséquence principale : le nombre de patients "effectif" est plus petit que la taille de la base de données $\rightarrow$ inflation de l'erreur de type 1

[Bonus Résidus](https://thomashusson29.github.io/M2biostatistiques/S8_bonus_residus.html)

## Quelques stratégies pour gérer la non-indépendance des observations

-   Ignorer l'effet centre / le caractère longitudinal

    -   Par ex : 4 visites pour 1 patient = 1 seul patient

    -   Problème : perte d'information donc perte de puissance

-   Estimer un modèle par centre / par patient et "combiner" les estimations

    -   Problème : pas de quantification de la variabilité inter-centres / inter-patients

-   Incorporer le centre / le patient comme effet fixe (c'est à dire comme une variable catégorielle / un facteur)

    -   Problème : perte de puissance, pas de quantification de la variabilité inter-centres / inter-patients, impossible si bcp de centres avec peu de patients par centre

[Bonus Variabilité](https://thomashusson29.github.io/M2biostatistiques/S8_B2_Variabilit%C3%A9s%20interindividuelles.html)

**Stratégie privilégiée** : Modèles linéaires mixtes (MLM) : 

-   Combine des effets **fixes** : covariables qui ont une influence sur la moyenne dont on veut estimer l'effet

-   et des effets **aléatoires** : variables qui modélisent la structure de corrélation entre les observations (rendent compte de la non-indépendance des observations)

Effets aléatoires : "covariables latentes" qui ne sont pas observées mais qui influencent la variable réponse

(par exemple $\rightarrow$ le fait que les patients d'un même centre se ressemblent plus que des patients de centres différents)

[Bonus effets](https://thomashusson29.github.io/M2biostatistiques/S8_B3_Effets_fixes_aleatoires.html)

Exemple d'effet aléatoire : **niveau de programmation en R dans la salle**

Probabilité de réponse dépend de la difficulté du questionnaire : impossible de la modéliser = effet non mesuré et aléatoire = effet aléatoire

## Le modèle linéaire mixte (formulation mathématique)

Modèle :\

$$
Y_{ij} = \beta X_{ij} + \gamma_1 Z_{ij} + \epsilon_{ij}
$$

-   $Y_{ij}$ : réponse (quantitative) pour l'observation du patient $j$ issu du cluster $i$ (par ex : mesure biologique au temps $j$ pour le patient $i$)

-   $\beta X_{ij}$ : effet fixe (unique ici) dépendant de la variable $X_{ij}$ (âge, sexe, traitement, etc.)

-   $\gamma_1 Z_{ij}$ : effet aléatoire dépendant de la variable $Z_{ij}$ (par ex : centre, patient, etc.). Le coefficient $\gamma_1$ est commun à tous les patients du cluster $i$ 

-   $\epsilon_{ij}$ : erreur aléatoire (résidu) pour l'observation du patient $j$ du cluster $i$ (dont on fait l'hypothèse qu'elle suit une loi normale centrée réduite $N(0,\sigma^2)$)

L'effet aléatoire $\gamma_i$ n'est pas observé, il faut spécifier sa loi ($\gamma_i \sim N(0,\sigma^2_Z)$)

Ainsi, 2 patients du même cluster $i$ se ressemblent plus que 2 patients de clusters différents car ils partagent la même valeur de l'effet aléatoire $\gamma_i$